<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase é€£ç·šæ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #667eea;
            margin-top: 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
    <script src="supabase-config.js"></script>
</head>
<body>
    <h1>ğŸ” Supabase é€£ç·šæ¸¬è©¦å·¥å…·</h1>
    
    <div class="test-section">
        <h2>1. æ¸¬è©¦åŸºæœ¬é€£ç·š</h2>
        <button onclick="testConnection()">æ¸¬è©¦ Supabase é€£ç·š</button>
        <div id="connectionResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. æ¸¬è©¦è³‡æ–™è¡¨æ˜¯å¦å­˜åœ¨</h2>
        <button onclick="testTables()">æª¢æŸ¥è³‡æ–™è¡¨</button>
        <div id="tablesResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. æ¸¬è©¦å¤ªé™½èƒ½æ¿è³‡æ–™</h2>
        <button onclick="testSolarPanels()">è¼‰å…¥å¤ªé™½èƒ½æ¿</button>
        <div id="solarResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. æ¸¬è©¦é€†è®Šå™¨è³‡æ–™</h2>
        <button onclick="testInverters()">è¼‰å…¥é€†è®Šå™¨</button>
        <div id="inverterResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>5. ç›´æ¥ API æ¸¬è©¦ï¼ˆä¸ä½¿ç”¨å°è£ï¼‰</h2>
        <button onclick="testDirectAPI('solar_panels')">ç›´æ¥æ¸¬è©¦ solar_panels</button>
        <button onclick="testDirectAPI('inverters')">ç›´æ¥æ¸¬è©¦ inverters</button>
        <div id="directResult" class="result"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ntlmothsjvhdvcykcvex.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50bG1vdGhzanZoZHZjeWtjdmV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NzEwMzIsImV4cCI6MjA4MTE0NzAzMn0.Fk2zZB7myLQnwx4Hiw678ggQYZ8ZaZDAW7UHH8eobO0';

        async function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ¸¬è©¦ä¸­...';
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… é€£ç·šæˆåŠŸï¼\nç‹€æ…‹ç¢¼: ${response.status}\nç‹€æ…‹æ–‡å­—: ${response.statusText}\nURL: ${SUPABASE_URL}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ é€£ç·šå¤±æ•—ï¼\néŒ¯èª¤: ${error.message}\n\nè«‹æª¢æŸ¥ï¼š\n1. ç¶²è·¯é€£ç·š\n2. Supabase URL æ˜¯å¦æ­£ç¢º\n3. æ˜¯å¦æœ‰ CORS å•é¡Œ`;
            }
        }

        async function testTables() {
            const resultDiv = document.getElementById('tablesResult');
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æª¢æŸ¥ä¸­...';
            
            try {
                // å˜—è©¦æŸ¥è©¢ information_schemaï¼ˆé€™å¯èƒ½éœ€è¦ç‰¹æ®Šæ¬Šé™ï¼‰
                // æ”¹ç‚ºç›´æ¥æ¸¬è©¦è¡¨æ˜¯å¦å­˜åœ¨
                const tests = [
                    { name: 'solar_panels', url: `${SUPABASE_URL}/rest/v1/solar_panels?limit=1` },
                    { name: 'inverters', url: `${SUPABASE_URL}/rest/v1/inverters?limit=1` },
                    { name: 'projects', url: `${SUPABASE_URL}/rest/v1/projects?limit=1` }
                ];
                
                let results = 'è³‡æ–™è¡¨æª¢æŸ¥çµæœï¼š\n\n';
                
                for (const test of tests) {
                    try {
                        const response = await fetch(test.url, {
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Prefer': 'return=representation'
                            }
                        });
                        
                        if (response.ok) {
                            results += `âœ… ${test.name}: å­˜åœ¨ (ç‹€æ…‹: ${response.status})\n`;
                        } else if (response.status === 404) {
                            results += `âŒ ${test.name}: ä¸å­˜åœ¨ (404)\n`;
                        } else {
                            const errorText = await response.text();
                            results += `âš ï¸ ${test.name}: éŒ¯èª¤ (${response.status})\n   ${errorText.substring(0, 200)}\n`;
                        }
                    } catch (error) {
                        results += `âŒ ${test.name}: è«‹æ±‚å¤±æ•—\n   éŒ¯èª¤: ${error.message}\n`;
                    }
                }
                
                resultDiv.className = 'result success';
                resultDiv.textContent = results;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æª¢æŸ¥å¤±æ•—ï¼\néŒ¯èª¤: ${error.message}`;
            }
        }

        async function testSolarPanels() {
            const resultDiv = document.getElementById('solarResult');
            resultDiv.className = 'result info';
            resultDiv.textContent = 'è¼‰å…¥ä¸­...';
            
            try {
                const panels = await supabase.getSolarPanels();
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… æˆåŠŸè¼‰å…¥ï¼\n\nè³‡æ–™ç­†æ•¸: ${panels ? panels.length : 0}\n\nè³‡æ–™å…§å®¹:\n${JSON.stringify(panels, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è¼‰å…¥å¤±æ•—ï¼\n\néŒ¯èª¤è¨Šæ¯: ${error.message}\n\nå¯èƒ½åŸå› ï¼š\n1. è³‡æ–™è¡¨ä¸å­˜åœ¨\n2. RLS æ”¿ç­–æœªè¨­å®š\n3. æ¬„ä½åç¨±ä¸åŒ¹é…\n\nè©³ç´°éŒ¯èª¤:\n${error.stack || error}`;
            }
        }

        async function testInverters() {
            const resultDiv = document.getElementById('inverterResult');
            resultDiv.className = 'result info';
            resultDiv.textContent = 'è¼‰å…¥ä¸­...';
            
            try {
                const inverters = await supabase.getInverters();
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… æˆåŠŸè¼‰å…¥ï¼\n\nè³‡æ–™ç­†æ•¸: ${inverters ? inverters.length : 0}\n\nè³‡æ–™å…§å®¹:\n${JSON.stringify(inverters, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è¼‰å…¥å¤±æ•—ï¼\n\néŒ¯èª¤è¨Šæ¯: ${error.message}\n\nå¯èƒ½åŸå› ï¼š\n1. è³‡æ–™è¡¨ä¸å­˜åœ¨\n2. RLS æ”¿ç­–æœªè¨­å®š\n3. æ¬„ä½åç¨±ä¸åŒ¹é…\n\nè©³ç´°éŒ¯èª¤:\n${error.stack || error}`;
            }
        }

        async function testDirectAPI(tableName) {
            const resultDiv = document.getElementById('directResult');
            resultDiv.className = 'result info';
            resultDiv.textContent = `æ¸¬è©¦ ${tableName}...`;
            
            try {
                const url = `${SUPABASE_URL}/rest/v1/${tableName}?limit=5&order=id.asc`;
                console.log('ç›´æ¥ API è«‹æ±‚:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    }
                });
                
                console.log('å›æ‡‰ç‹€æ…‹:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ è«‹æ±‚å¤±æ•—ï¼\n\nç‹€æ…‹ç¢¼: ${response.status}\nç‹€æ…‹æ–‡å­—: ${response.statusText}\n\nå›æ‡‰å…§å®¹:\n${errorText}`;
                    return;
                }
                
                const data = await response.json();
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… æˆåŠŸï¼\n\nç‹€æ…‹ç¢¼: ${response.status}\nè³‡æ–™ç­†æ•¸: ${data ? data.length : 0}\n\nè³‡æ–™å…§å®¹:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è«‹æ±‚å¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}\n\nè©³ç´°:\n${error.stack || error}`;
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦é€£ç·š
        window.addEventListener('load', () => {
            console.log('æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('Supabase URL:', SUPABASE_URL);
            console.log('Supabase Key:', SUPABASE_KEY.substring(0, 20) + '...');
        });
    </script>
</body>
</html>

