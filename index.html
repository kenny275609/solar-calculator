<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ªé™½å…‰é›»ç³»çµ±è¦åŠƒè¨ˆç®—å·¥å…·</title>
    <script src="supabase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            color: #666;
            margin-top: 5px;
            font-size: 0.85em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: block;
            margin: 30px auto;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #34d399 0%, #059669 100%);
            margin: 0;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 10px 0 30px;
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .results.show {
            display: block;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .result-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: bold;
            color: #555;
        }

        .result-value {
            color: #333;
            font-weight: 600;
        }

        .formula {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }

        /* å°ˆæ¡ˆç®¡ç†æ¨£å¼ */
        .project-management {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .project-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            margin: 0;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            margin: 0;
            color: #667eea;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .project-list {
            list-style: none;
            padding: 0;
        }

        .project-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }

        .project-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .project-info {
            flex: 1;
        }

        .project-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .project-meta {
            font-size: 0.85em;
            color: #666;
        }

        .project-item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>â˜€ï¸ å¤ªé™½å…‰é›»ç³»çµ±è¦åŠƒè¨ˆç®—å·¥å…·</h1>
            <p>è¨ˆç®—å¤ªé™½èƒ½æ¿é™£åˆ—ã€é€†è®Šå™¨é¸å‹ã€ç·šå¾‘è¦åŠƒèˆ‡ä¿è­·å…ƒä»¶</p>
        </div>

        <div class="content">
            <!-- å°ˆæ¡ˆç®¡ç†å€åŸŸ -->
            <div class="project-management">
                <div>
                    <h3 style="margin: 0; color: #333;">å°ˆæ¡ˆç®¡ç†</h3>
                    <small style="color: #666;">ç®¡ç†æ‚¨çš„å¤ªé™½å…‰é›»è¦åŠƒå°ˆæ¡ˆ</small>
                </div>
                <div class="project-actions">
                    <button type="button" class="btn btn-small btn-info" onclick="showProjectList()">ğŸ“‹ å°ˆæ¡ˆåˆ—è¡¨</button>
                    <button type="button" class="btn btn-small btn-success" onclick="saveProject()">ğŸ’¾ ä¿å­˜å°ˆæ¡ˆ</button>
                    <button type="button" class="btn btn-small btn-warning" onclick="loadProject()">ğŸ“‚ è¼‰å…¥å°ˆæ¡ˆ</button>
                    <button type="button" class="btn btn-small" onclick="newProject()">â• æ–°å»ºå°ˆæ¡ˆ</button>
                </div>
            </div>

            <form id="calculationForm">
                <!-- åŸºæœ¬ç³»çµ±åƒæ•¸ -->
                <div class="section">
                    <h2>ğŸ“Œ åŸºæœ¬ç³»çµ±åƒæ•¸</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ç¸½ç³»çµ±å®¹é‡ P<sub>sys</sub> (kWp)</label>
                            <input type="number" id="Psys" step="0.1" value="10" required>
                            <small>ä¾‹å¦‚: 10 kWp</small>
                        </div>
                        <div class="form-group">
                            <label>é›»ç¶²é›»å£“ V<sub>grid</sub> (V)</label>
                            <select id="Vgrid" required>
                                <option value="220">220 V (å–®ç›¸)</option>
                                <option value="380">380 V (ä¸‰ç›¸)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æœ€ä½ç’°å¢ƒæº«åº¦ T<sub>min</sub> (Â°C)</label>
                            <input type="number" id="Tmin" step="1" value="-10" required>
                            <small>ä¾‹å¦‚: -10Â°C</small>
                        </div>
                        <div class="form-group">
                            <label>æœ€é«˜ç’°å¢ƒæº«åº¦ T<sub>max</sub> (Â°C)</label>
                            <input type="number" id="Tmax" step="1" value="40" required>
                            <small>ä¾‹å¦‚: 40Â°C</small>
                        </div>
                    </div>
                </div>

                <!-- å¤ªé™½èƒ½æ¿è¦æ ¼ -->
                <div class="section">
                    <h2>ğŸ”‹ å¤ªé™½èƒ½æ¿è¦æ ¼</h2>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="flex: 1;">
                                    <label>é¸æ“‡å¤ªé™½èƒ½æ¿å‹è™Ÿ *</label>
                                    <select id="solarPanelSelect" required onchange="loadSolarPanelSpecs()" style="width: 100%;">
                                        <option value="">-- è«‹é¸æ“‡å¤ªé™½èƒ½æ¿ --</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-small btn-info" onclick="loadSolarPanels()" style="margin-top: 20px; white-space: nowrap;">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                            </div>
                            <small>å¾è³‡æ–™åº«é¸æ“‡å¤ªé™½èƒ½æ¿ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥ä¸‹æ–¹è¦æ ¼</small>
                        </div>
                        <div class="form-group">
                            <label>å–®ç‰‡åŠŸç‡ P<sub>mod</sub> (W)</label>
                            <input type="number" id="Pmod" step="1" value="400" required>
                            <small>ä¾‹å¦‚: 400 W</small>
                        </div>
                        <div class="form-group">
                            <label>æœ€å¤§åŠŸç‡é»é›»å£“ V<sub>mpp</sub> (V)</label>
                            <input type="number" id="Vmpp" step="0.1" value="41.0" required>
                            <small>ä¾‹å¦‚: 41.0 V</small>
                        </div>
                        <div class="form-group">
                            <label>æœ€å¤§åŠŸç‡é»é›»æµ I<sub>mpp</sub> (A)</label>
                            <input type="number" id="Impp" step="0.01" value="9.76" required>
                            <small>ä¾‹å¦‚: 9.76 A</small>
                        </div>
                        <div class="form-group">
                            <label>é–‹è·¯é›»å£“ V<sub>oc</sub> (V)</label>
                            <input type="number" id="Voc" step="0.1" value="49.5" required>
                            <small>ä¾‹å¦‚: 49.5 V</small>
                        </div>
                        <div class="form-group">
                            <label>çŸ­è·¯é›»æµ I<sub>sc</sub> (A)</label>
                            <input type="number" id="Isc" step="0.01" value="10.35" required>
                            <small>ä¾‹å¦‚: 10.35 A</small>
                        </div>
                        <div class="form-group">
                            <label>é›»å£“æº«åº¦ä¿‚æ•¸ Î±<sub>Voc</sub> (%/Â°C)</label>
                            <input type="number" id="alphaVoc" step="0.001" value="-0.27" required>
                            <small>é€šå¸¸ç‚ºè² å€¼ï¼Œä¾‹å¦‚: -0.27 %/Â°C</small>
                        </div>
                        <div class="form-group">
                            <label>é›»æµæº«åº¦ä¿‚æ•¸ Î±<sub>Isc</sub> (%/Â°C)</label>
                            <input type="number" id="alphaIsc" step="0.001" value="0.05" required>
                            <small>é€šå¸¸ç‚ºæ­£å€¼ï¼Œä¾‹å¦‚: 0.05 %/Â°C</small>
                        </div>
                    </div>
                </div>

                <!-- é€†è®Šå™¨è¦æ ¼ -->
                <div class="section">
                    <h2>âš¡ é€†è®Šå™¨è¦æ ¼</h2>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="flex: 1;">
                                    <label>é¸æ“‡é€†è®Šå™¨å‹è™Ÿ *</label>
                                    <select id="inverterSelect" required onchange="loadInverterSpecs()" style="width: 100%;">
                                        <option value="">-- è«‹é¸æ“‡é€†è®Šå™¨ --</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-small btn-info" onclick="loadInverters()" style="margin-top: 20px; white-space: nowrap;">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                            </div>
                            <small>å¾è³‡æ–™åº«é¸æ“‡é€†è®Šå™¨ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥ä¸‹æ–¹è¦æ ¼</small>
                        </div>
                        <div class="form-group">
                            <label>æœ€å¤§è¼¸å…¥é›»å£“ V<sub>inv,max</sub> (V)</label>
                            <input type="number" id="VinvMax" step="1" value="1000" required>
                            <small>ä¾‹å¦‚: 1000 V</small>
                        </div>
                        <div class="form-group">
                            <label>MPPT æœ€å°é›»å£“ V<sub>inv,mppt,min</sub> (V)</label>
                            <input type="number" id="VinvMpptMin" step="1" value="200" required>
                            <small>ä¾‹å¦‚: 200 V</small>
                        </div>
                        <div class="form-group">
                            <label>MPPT æœ€å¤§é›»å£“ V<sub>inv,mppt,max</sub> (V)</label>
                            <input type="number" id="VinvMpptMax" step="1" value="800" required>
                            <small>ä¾‹å¦‚: 800 V</small>
                        </div>
                        <div class="form-group">
                            <label>æœ€å¤§è¼¸å…¥é›»æµ I<sub>inv,max</sub> (A)</label>
                            <input type="number" id="IinvMax" step="0.1" value="22" required>
                            <small>ä¾‹å¦‚: 22 A</small>
                        </div>
                        <div class="form-group">
                            <label>é¡å®šè¼¸å‡ºåŠŸç‡ P<sub>inv,rated</sub> (kW)</label>
                            <input type="number" id="PinvRated" step="0.1" value="10" required>
                            <small>ä¾‹å¦‚: 10 kW</small>
                        </div>
                        <div class="form-group">
                            <label>é¡å®šè¼¸å‡ºé›»æµ I<sub>inv,rated</sub> (A)</label>
                            <input type="number" id="IinvRated" step="0.1" value="45.5" required>
                            <small>ä¾‹å¦‚: 45.5 A (220Væ™‚)</small>
                        </div>
                    </div>
                </div>

                <!-- ç·šè·¯åƒæ•¸ -->
                <div class="section">
                    <h2>ğŸ”Œ ç·šè·¯åƒæ•¸</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>DC ç·šè·¯é•·åº¦ L<sub>DC</sub> (m)</label>
                            <input type="number" id="Ldc" step="1" value="50" required>
                            <small>å¾å¤ªé™½èƒ½æ¿åˆ°é€†è®Šå™¨çš„è·é›¢</small>
                        </div>
                        <div class="form-group">
                            <label>AC ç·šè·¯é•·åº¦ L<sub>AC</sub> (m)</label>
                            <input type="number" id="Lac" step="1" value="20" required>
                            <small>å¾é€†è®Šå™¨åˆ°é›»ç¶²çš„è·é›¢</small>
                        </div>
                        <div class="form-group">
                            <label>ç·šæå‘¨åœæº«åº¦ (Â°C)</label>
                            <input type="number" id="Twire" step="1" value="40" required>
                            <small>ç”¨æ–¼è¼‰æµé‡ä¿®æ­£</small>
                        </div>
                        <div class="form-group">
                            <label>å°é«”é›»é˜»ç‡ Ï (Î©Â·mmÂ²/m)</label>
                            <input type="number" id="rho" step="0.0001" value="0.0172" required>
                            <small>éŠ…å°é«”ç´„ 0.0172</small>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn">ğŸš€ é–‹å§‹è¨ˆç®—</button>
            </form>

            <!-- è¨ˆç®—çµæœ -->
            <div id="results" class="results">
                <div class="actions">
                    <button type="button" class="btn secondary" onclick="exportPDF()">ğŸ“„ åŒ¯å‡º PDF å ±è¡¨</button>
                </div>
                <!-- é™£åˆ—è¦åŠƒçµæœ -->
                <div class="result-card">
                    <h3>ğŸ“Š å¤ªé™½èƒ½æ¿é™£åˆ—è¦åŠƒ</h3>
                    <div id="arrayResults"></div>
                </div>

                <!-- é€†è®Šå™¨è¦åŠƒçµæœ -->
                <div class="result-card">
                    <h3>âš¡ é€†è®Šå™¨è¦åŠƒ</h3>
                    <div id="inverterResults"></div>
                </div>

                <!-- ç·šå¾‘è¦åŠƒçµæœ -->
                <div class="result-card">
                    <h3>ğŸ”Œ ç·šå¾‘è¦åŠƒ</h3>
                    <div id="cableResults"></div>
                </div>

                <!-- ä¿è­·å…ƒä»¶è¦åŠƒçµæœ -->
                <div class="result-card">
                    <h3>ğŸ›¡ï¸ ä¿è­·å…ƒä»¶è¦åŠƒ</h3>
                    <div id="protectionResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å°ˆæ¡ˆåˆ—è¡¨æ¨¡æ…‹æ¡† -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ å°ˆæ¡ˆåˆ—è¡¨</h2>
                <span class="close" onclick="closeProjectModal()">&times;</span>
            </div>
            <div id="projectListContent">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- ä¿å­˜å°ˆæ¡ˆæ¨¡æ…‹æ¡† -->
    <div id="saveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ’¾ ä¿å­˜å°ˆæ¡ˆ</h2>
                <span class="close" onclick="closeSaveModal()">&times;</span>
            </div>
            <div class="input-group">
                <label>å°ˆæ¡ˆåç¨± *</label>
                <input type="text" id="projectName" placeholder="è¼¸å…¥å°ˆæ¡ˆåç¨±" required>
            </div>
            <div class="input-group">
                <label>å°ˆæ¡ˆæè¿°</label>
                <input type="text" id="projectDescription" placeholder="è¼¸å…¥å°ˆæ¡ˆæè¿°ï¼ˆé¸å¡«ï¼‰">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-small" onclick="closeSaveModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-small btn-success" onclick="confirmSaveProject()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥å°ˆæ¡ˆæ¨¡æ…‹æ¡† -->
    <div id="loadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‚ è¼‰å…¥å°ˆæ¡ˆ</h2>
                <span class="close" onclick="closeLoadModal()">&times;</span>
            </div>
            <div id="loadProjectListContent">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // è¼‰æµé‡è¡¨ (éŠ…å°é«”ï¼Œå–®èŠ¯ï¼Œç’°å¢ƒæº«åº¦ 30Â°Cï¼Œåƒè€ƒå€¼)
        const currentCapacityTable = {
            1.5: 20,
            2.5: 27,
            4: 36,
            6: 46,
            10: 63,
            16: 85,
            25: 115,
            35: 140,
            50: 175,
            70: 225,
            95: 275,
            120: 320,
            150: 375,
            185: 430,
            240: 520
        };

        // ç´€éŒ„æœ€æ–°è¨ˆç®—è¼¸å…¥èˆ‡çµæœ
        let lastInputs = null;
        let lastResults = null;
        let currentProjectId = null; // ç•¶å‰ç·¨è¼¯çš„å°ˆæ¡ˆ ID
        
        // è¨­å‚™è³‡æ–™å¿«å–
        let solarPanelsData = [];
        let invertersData = [];
        
        // è¼‰æµé‡è¡¨å¿«å–ï¼ˆå¾è³‡æ–™åº«è¼‰å…¥ï¼‰
        let ampacityTable = null;
        let ampacityTableLoaded = false;

        // æº«åº¦ä¿®æ­£ä¿‚æ•¸ (ç’°å¢ƒæº«åº¦ vs ç·šæé¡å®šæº«åº¦ 90Â°C)
        function getTempCorrectionFactor(Twire) {
            if (Twire <= 30) return 1.0;
            if (Twire <= 35) return 0.94;
            if (Twire <= 40) return 0.87;
            if (Twire <= 45) return 0.79;
            if (Twire <= 50) return 0.71;
            if (Twire <= 55) return 0.61;
            if (Twire <= 60) return 0.50;
            return 0.40;
        }

        // å¾è³‡æ–™åº«è¼‰å…¥è¼‰æµé‡è¡¨
        async function loadAmpacityTable(wireType = 'metal', temperature = 60, wireStructure = '3') {
            try {
                let data = null;
                
                // æ ¹æ“šç·šæé¡å‹å’Œæº«åº¦é¸æ“‡æ­£ç¢ºçš„è¡¨
                if (wireType === 'metal') {
                    if (temperature === 60) {
                        data = await supabase.getAmpacityMetal60C();
                    } else if (temperature === 75) {
                        data = await supabase.getAmpacityMetal75C();
                    } else if (temperature === 90) {
                        data = await supabase.getAmpacityMetal90C();
                    }
                } else if (wireType === 'pvc') {
                    data = await supabase.getAmpacityPVC60C();
                }
                
                if (data && data.length > 0) {
                    // è½‰æ›ç‚ºæ˜“æ–¼ä½¿ç”¨çš„æ ¼å¼
                    const table = {};
                    data.forEach(row => {
                        const area = parseFloat(row.nominal_area_mm2);
                        // æ ¹æ“šç·šæçµæ§‹é¸æ“‡å°æ‡‰çš„è¼‰æµé‡æ¬„ä½
                        let ampacity = null;
                        if (wireStructure === '3') {
                            ampacity = row.amp_3_be || row.amp_3 || null;
                        } else if (wireStructure === '4') {
                            ampacity = row.amp_4 || null;
                        } else if (wireStructure === '5' || wireStructure === '6') {
                            ampacity = row.amp_5_6 || null;
                        } else if (wireStructure === '7' || wireStructure === '8' || wireStructure === '9') {
                            ampacity = row.amp_7_9 || null;
                        }
                        
                        if (ampacity !== null && area) {
                            table[area] = parseFloat(ampacity);
                        }
                    });
                    
                    ampacityTable = table;
                    ampacityTableLoaded = true;
                    console.log('è¼‰æµé‡è¡¨è¼‰å…¥æˆåŠŸ:', table);
                    return table;
                } else {
                    console.warn('è¼‰æµé‡è¡¨ç‚ºç©ºï¼Œä½¿ç”¨é è¨­å€¼');
                    ampacityTable = currentCapacityTable;
                    return currentCapacityTable;
                }
            } catch (error) {
                console.error('è¼‰å…¥è¼‰æµé‡è¡¨å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼:', error);
                ampacityTable = currentCapacityTable;
                return currentCapacityTable;
            }
        }

        // é¸æ“‡æœ€å°ç·šå¾‘ï¼ˆæ”¹é€²ç‰ˆï¼Œæ”¯æ´å¾è³‡æ–™åº«è®€å–ï¼‰
        async function selectCableSize(requiredCurrent, Twire, wireType = 'metal', wireStructure = '3') {
            // å¦‚æœè¼‰æµé‡è¡¨æœªè¼‰å…¥ï¼Œå…ˆè¼‰å…¥
            if (!ampacityTableLoaded || !ampacityTable) {
                await loadAmpacityTable(wireType, 60, wireStructure);
            }
            
            const table = ampacityTable || currentCapacityTable;
            const Ctemp = getTempCorrectionFactor(Twire);
            const Cbundling = 0.8; // å‡è¨­å¤šæ¢ç·šæ†ç´®
            const adjustedCurrent = requiredCurrent / Ctemp / Cbundling;

            // å°‡è¡¨è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
            const sortedSizes = Object.entries(table)
                .map(([size, capacity]) => ({ size: parseFloat(size), capacity }))
                .sort((a, b) => a.size - b.size);

            // æ‰¾åˆ°ç¬¬ä¸€å€‹ç¬¦åˆæ¢ä»¶çš„ç·šå¾‘
            for (const item of sortedSizes) {
                if (item.capacity >= adjustedCurrent) {
                    return item.size;
                }
            }
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œè¿”å›æœ€å¤§å°ºå¯¸
            return sortedSizes[sortedSizes.length - 1]?.size || 240;
        }
        
        // åŒæ­¥ç‰ˆæœ¬çš„é¸æ“‡ç·šå¾‘ï¼ˆç”¨æ–¼å‘å¾Œå…¼å®¹ï¼‰
        function selectCableSizeSync(requiredCurrent, Twire) {
            const Ctemp = getTempCorrectionFactor(Twire);
            const Cbundling = 0.8;
            const adjustedCurrent = requiredCurrent / Ctemp / Cbundling;

            const table = ampacityTable || currentCapacityTable;
            const sortedSizes = Object.entries(table)
                .map(([size, capacity]) => ({ size: parseFloat(size), capacity }))
                .sort((a, b) => a.size - b.size);

            for (const item of sortedSizes) {
                if (item.capacity >= adjustedCurrent) {
                    return item.size;
                }
            }
            return sortedSizes[sortedSizes.length - 1]?.size || 240;
        }

        // è¨ˆç®—é›»å£“é™ç™¾åˆ†æ¯”
        function calculateVoltageDrop(L, I, V, A, rho) {
            return (2 * L * I * rho) / (A * V) * 100;
        }

        document.getElementById('calculationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // è®€å–è¼¸å…¥åƒæ•¸
            const Psys = parseFloat(document.getElementById('Psys').value) * 1000; // è½‰æ›ç‚º W
            const Vgrid = parseFloat(document.getElementById('Vgrid').value);
            const Tmin = parseFloat(document.getElementById('Tmin').value);
            const Tmax = parseFloat(document.getElementById('Tmax').value);
            
            const Pmod = parseFloat(document.getElementById('Pmod').value);
            const Vmpp = parseFloat(document.getElementById('Vmpp').value);
            const Impp = parseFloat(document.getElementById('Impp').value);
            const Voc = parseFloat(document.getElementById('Voc').value);
            const Isc = parseFloat(document.getElementById('Isc').value);
            const alphaVoc = parseFloat(document.getElementById('alphaVoc').value) / 100; // è½‰æ›ç‚ºå°æ•¸
            const alphaIsc = parseFloat(document.getElementById('alphaIsc').value) / 100;
            
            const VinvMax = parseFloat(document.getElementById('VinvMax').value);
            const VinvMpptMin = parseFloat(document.getElementById('VinvMpptMin').value);
            const VinvMpptMax = parseFloat(document.getElementById('VinvMpptMax').value);
            const IinvMax = parseFloat(document.getElementById('IinvMax').value);
            const PinvRated = parseFloat(document.getElementById('PinvRated').value) * 1000; // è½‰æ›ç‚º W
            const IinvRated = parseFloat(document.getElementById('IinvRated').value);
            
            const Ldc = parseFloat(document.getElementById('Ldc').value);
            const Lac = parseFloat(document.getElementById('Lac').value);
            const Twire = parseFloat(document.getElementById('Twire').value);
            const rho = parseFloat(document.getElementById('rho').value);

            // ç²å–é¸ä¸­çš„è¨­å‚™ ID
            const selectedSolarPanelId = document.getElementById('solarPanelSelect').value;
            const selectedInverterId = document.getElementById('inverterSelect').value;
            
            lastInputs = {
                Psys, Vgrid, Tmin, Tmax,
                Pmod, Vmpp, Impp, Voc, Isc, alphaVoc, alphaIsc,
                VinvMax, VinvMpptMin, VinvMpptMax, IinvMax, PinvRated, IinvRated,
                Ldc, Lac, Twire, rho,
                solarPanelId: selectedSolarPanelId || null,
                inverterId: selectedInverterId || null
            };

            // ========== 1. é™£åˆ—è¦åŠƒè¨ˆç®— ==========
            
            // è¨ˆç®—æº«åº¦ä¿®æ­£å¾Œçš„é›»å£“å’Œé›»æµ
            const VocTmin = Voc * (1 + alphaVoc * (Tmin - 25));
            const VmppTmax = Vmpp * (1 + alphaVoc * (Tmax - 25));
            const IscTmax = Isc * (1 + alphaIsc * (Tmax - 25));

            // è¨ˆç®—æœ€å¤§å’Œæœ€å°ä¸²è¯ç‰‡æ•¸
            const Nmax = Math.floor(VinvMax / VocTmin);
            const Nmin = Math.ceil(VinvMpptMin / VmppTmax);

            if (Nmin > Nmax) {
                alert('éŒ¯èª¤ï¼šç„¡æ³•æ‰¾åˆ°åˆé©çš„ä¸²è¯ç‰‡æ•¸ï¼è«‹æª¢æŸ¥é€†è®Šå™¨å’Œå¤ªé™½èƒ½æ¿è¦æ ¼ã€‚');
                return;
            }

            // é¸æ“‡ä¸²è¯ç‰‡æ•¸ï¼ˆé¸æ“‡ä¸­é–“å€¼ï¼‰
            const Nseries = Math.floor((Nmin + Nmax) / 2);

            // è¨ˆç®—ç¸½ç‰‡æ•¸å’Œä¸¦è¯ä¸²åˆ—æ•¸
            const Ntotal = Math.ceil(Psys / Pmod);
            const Nparallel = Math.ceil(Ntotal / Nseries);

            // è¨ˆç®—é™£åˆ—ç¸½é›»æµ
            const Iarray = Nparallel * IscTmax;

            // æª¢æŸ¥é›»æµæ˜¯å¦è¶…éé€†è®Šå™¨é™åˆ¶
            if (Iarray > IinvMax) {
                alert('è­¦å‘Šï¼šé™£åˆ—ç¸½é›»æµè¶…éé€†è®Šå™¨æœ€å¤§è¼¸å…¥é›»æµï¼');
            }

            // è¨ˆç®—é™£åˆ—é›»å£“
            const Varray = Nseries * Vmpp;

            // ========== 2. é€†è®Šå™¨è¦åŠƒ ==========
            const inverterCheck = PinvRated >= Psys * 0.9; // é€†è®Šå™¨åŠŸç‡æ‡‰è‡³å°‘ç‚ºç³»çµ±å®¹é‡çš„90%

            // ========== 3. ç·šå¾‘è¨ˆç®— ==========
            
            // DC å´ç·šå¾‘
            const Istring = Isc * 1.25;
            const IDcMax = Iarray * 1.25;
            // ä½¿ç”¨åŒæ­¥ç‰ˆæœ¬ï¼ˆå› ç‚ºåœ¨åŒæ­¥å‡½æ•¸ä¸­ï¼‰
            const AdcMin = selectCableSizeSync(IDcMax, Twire);
            
            // DC é›»å£“é™è¨ˆç®—
            const VdcDrop = calculateVoltageDrop(Ldc, Impp * Nparallel, Varray, AdcMin, rho);
            
            // AC å´ç·šå¾‘
            const IAcMax = IinvRated * 1.25;
            // ä½¿ç”¨åŒæ­¥ç‰ˆæœ¬ï¼ˆå› ç‚ºåœ¨åŒæ­¥å‡½æ•¸ä¸­ï¼‰
            const AacMin = selectCableSizeSync(IAcMax, Twire);
            
            // AC é›»å£“é™è¨ˆç®—
            const VacDrop = calculateVoltageDrop(Lac, IinvRated, Vgrid, AacMin, rho);

            // ========== 4. ä¿è­·å…ƒä»¶è¦åŠƒ ==========
            
            // DC ä¿éšªçµ²
            const Ifuse = Math.ceil(Isc * 1.25);
            const Vfuse = Math.ceil(VocTmin * Nseries * 1.2); // å¢åŠ 20%å®‰å…¨é¤˜é‡
            
            // DC æ–·è·¯å™¨
            const IDcBreaker = Math.ceil(IDcMax);
            const VDcBreaker = Math.ceil(VocTmin * Nseries * 1.2);
            
            // AC æ–·è·¯å™¨
            const IAcBreaker = Math.ceil(IAcMax);
            const VAcBreaker = Math.ceil(Vgrid * 1.2);

            // ========== é¡¯ç¤ºçµæœ ==========
            const calculatedResults = {
                // é™£åˆ—è¦åŠƒ
                Nseries, Nparallel, Ntotal,
                VocTmin, VmppTmax, IscTmax,
                Varray, Iarray,
                Nmin, Nmax,
                
                // é€†è®Šå™¨
                PinvRated, inverterCheck,
                
                // ç·šå¾‘
                IDcMax, AdcMin, VdcDrop, Ldc,
                IAcMax, AacMin, VacDrop, Lac,
                
                // ä¿è­·å…ƒä»¶
                Ifuse, Vfuse,
                IDcBreaker, VDcBreaker,
                IAcBreaker, VAcBreaker
            };

            lastResults = calculatedResults;
            displayResults(calculatedResults);
        });

        function displayResults(results) {
            // é™£åˆ—è¦åŠƒçµæœ
            let arrayHTML = `
                <div class="result-item">
                    <span class="result-label">ç¸½å¤ªé™½èƒ½æ¿ç‰‡æ•¸</span>
                    <span class="result-value">${results.Ntotal} ç‰‡</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ä¸²è¯ç‰‡æ•¸ (N<sub>series</sub>)</span>
                    <span class="result-value">${results.Nseries} ç‰‡</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ä¸¦è¯ä¸²åˆ—æ•¸ (N<sub>parallel</sub>)</span>
                    <span class="result-value">${results.Nparallel} ä¸²</span>
                </div>
                <div class="result-item">
                    <span class="result-label">é™£åˆ—é…ç½®</span>
                    <span class="result-value">${results.Nseries} ä¸² Ã— ${results.Nparallel} ä¸¦</span>
                </div>
                <div class="formula">
                    <strong>è¨ˆç®—éç¨‹ï¼š</strong><br>
                    æœ€å¤§ä¸²è¯ç‰‡æ•¸ N<sub>max</sub> = floor(${results.Nmax}) = ${results.Nmax} ç‰‡<br>
                    æœ€å°ä¸²è¯ç‰‡æ•¸ N<sub>min</sub> = ceil(${results.Nmin}) = ${results.Nmin} ç‰‡<br>
                    é¸æ“‡ä¸²è¯ç‰‡æ•¸ = ${results.Nseries} ç‰‡ (ä»‹æ–¼ N<sub>min</sub> å’Œ N<sub>max</sub> ä¹‹é–“)
                </div>
                <div class="result-item">
                    <span class="result-label">æœ€ä½æº«é–‹è·¯é›»å£“ V<sub>oc,Tmin</sub></span>
                    <span class="result-value">${results.VocTmin.toFixed(2)} V</span>
                </div>
                <div class="result-item">
                    <span class="result-label">æœ€é«˜æº« MPPT é›»å£“ V<sub>mpp,Tmax</sub></span>
                    <span class="result-value">${results.VmppTmax.toFixed(2)} V</span>
                </div>
                <div class="result-item">
                    <span class="result-label">æœ€é«˜æº«çŸ­è·¯é›»æµ I<sub>sc,Tmax</sub></span>
                    <span class="result-value">${results.IscTmax.toFixed(2)} A</span>
                </div>
                <div class="result-item">
                    <span class="result-label">é™£åˆ—ç¸½é›»å£“ (V<sub>array</sub>)</span>
                    <span class="result-value">${results.Varray.toFixed(2)} V</span>
                </div>
                <div class="result-item">
                    <span class="result-label">é™£åˆ—ç¸½é›»æµ (I<sub>array</sub>)</span>
                    <span class="result-value">${results.Iarray.toFixed(2)} A</span>
                </div>
            `;

            // é€†è®Šå™¨è¦åŠƒçµæœ
            let inverterHTML = `
                <div class="result-item">
                    <span class="result-label">é€†è®Šå™¨é¡å®šåŠŸç‡</span>
                    <span class="result-value">${(results.PinvRated / 1000).toFixed(1)} kW</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ç³»çµ±å®¹é‡</span>
                    <span class="result-value">${(results.Ntotal * parseFloat(document.getElementById('Pmod').value) / 1000).toFixed(1)} kWp</span>
                </div>
                ${results.inverterCheck ? 
                    '<div class="success">âœ“ é€†è®Šå™¨åŠŸç‡ç¬¦åˆè¦æ±‚ï¼ˆâ‰¥ ç³»çµ±å®¹é‡çš„ 90%ï¼‰</div>' : 
                    '<div class="warning">âš  å»ºè­°æª¢æŸ¥é€†è®Šå™¨åŠŸç‡æ˜¯å¦è¶³å¤ </div>'}
            `;

            // ç·šå¾‘è¦åŠƒçµæœ
            let cableHTML = `
                <h4 style="margin-top: 15px; color: #667eea;">ç›´æµ (DC) å´</h4>
                <div class="result-item">
                    <span class="result-label">æœ€å¤§é›»æµ I<sub>DC,max</sub></span>
                    <span class="result-value">${results.IDcMax.toFixed(2)} A</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å»ºè­°ç·šå¾‘</span>
                    <span class="result-value">${results.AdcMin} mmÂ²</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ç·šè·¯é•·åº¦</span>
                    <span class="result-value">${results.Ldc} m</span>
                </div>
                <div class="result-item">
                    <span class="result-label">é›»å£“é™</span>
                    <span class="result-value">${results.VdcDrop.toFixed(2)} %</span>
                </div>
                ${results.VdcDrop <= 2 ? 
                    '<div class="success">âœ“ DC å´é›»å£“é™ç¬¦åˆè¦ç¯„ï¼ˆâ‰¤ 2%ï¼‰</div>' : 
                    '<div class="warning">âš  DC å´é›»å£“é™è¶…éå»ºè­°å€¼ï¼Œè€ƒæ…®ä½¿ç”¨æ›´å¤§ç·šå¾‘</div>'}
                
                <h4 style="margin-top: 20px; color: #667eea;">äº¤æµ (AC) å´</h4>
                <div class="result-item">
                    <span class="result-label">æœ€å¤§é›»æµ I<sub>AC,max</sub></span>
                    <span class="result-value">${results.IAcMax.toFixed(2)} A</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å»ºè­°ç·šå¾‘</span>
                    <span class="result-value">${results.AacMin} mmÂ²</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ç·šè·¯é•·åº¦</span>
                    <span class="result-value">${results.Lac} m</span>
                </div>
                <div class="result-item">
                    <span class="result-label">é›»å£“é™</span>
                    <span class="result-value">${results.VacDrop.toFixed(2)} %</span>
                </div>
                ${results.VacDrop <= 3 ? 
                    '<div class="success">âœ“ AC å´é›»å£“é™ç¬¦åˆè¦ç¯„ï¼ˆâ‰¤ 3%ï¼‰</div>' : 
                    '<div class="warning">âš  AC å´é›»å£“é™è¶…éå»ºè­°å€¼ï¼Œè€ƒæ…®ä½¿ç”¨æ›´å¤§ç·šå¾‘</div>'}
            `;

            // ä¿è­·å…ƒä»¶è¦åŠƒçµæœ
            let protectionHTML = `
                <h4 style="margin-top: 15px; color: #667eea;">ç›´æµ (DC) å´ä¿è­·</h4>
                <div class="result-item">
                    <span class="result-label">ä¸²åˆ—ä¿éšªçµ²é¡å®šé›»æµ</span>
                    <span class="result-value">â‰¥ ${results.Ifuse} A</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ä¸²åˆ—ä¿éšªçµ²é¡å®šé›»å£“</span>
                    <span class="result-value">â‰¥ ${results.Vfuse} V</span>
                </div>
                <div class="result-item">
                    <span class="result-label">DC æ–·è·¯å™¨é¡å®šé›»æµ</span>
                    <span class="result-value">â‰¥ ${results.IDcBreaker} A</span>
                </div>
                <div class="result-item">
                    <span class="result-label">DC æ–·è·¯å™¨é¡å®šé›»å£“</span>
                    <span class="result-value">â‰¥ ${results.VDcBreaker} V</span>
                </div>
                
                <h4 style="margin-top: 20px; color: #667eea;">äº¤æµ (AC) å´ä¿è­·</h4>
                <div class="result-item">
                    <span class="result-label">AC æ–·è·¯å™¨é¡å®šé›»æµ</span>
                    <span class="result-value">â‰¥ ${results.IAcBreaker} A</span>
                </div>
                <div class="result-item">
                    <span class="result-label">AC æ–·è·¯å™¨é¡å®šé›»å£“</span>
                    <span class="result-value">â‰¥ ${results.VAcBreaker} V</span>
                </div>
            `;

            document.getElementById('arrayResults').innerHTML = arrayHTML;
            document.getElementById('inverterResults').innerHTML = inverterHTML;
            document.getElementById('cableResults').innerHTML = cableHTML;
            document.getElementById('protectionResults').innerHTML = protectionHTML;

            // é¡¯ç¤ºçµæœå€åŸŸ
            document.getElementById('results').classList.add('show');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ç”¢ç”Ÿ PDF å ±è¡¨ï¼ˆåˆ©ç”¨ç€è¦½å™¨åˆ—å°æˆ PDFï¼‰
        function exportPDF() {
            if (!lastResults || !lastInputs) {
                alert('è«‹å…ˆå®Œæˆè¨ˆç®—ï¼Œå†åŒ¯å‡º PDF å ±è¡¨ã€‚');
                return;
            }

            const now = new Date();
            const formattedDate = now.toLocaleString();

            const summaryHTML = `
                <div class="result-card">
                    <h3>ğŸ“ è¨ˆç®—è¼¸å…¥æ‘˜è¦</h3>
                    <div class="result-item"><span class="result-label">ç³»çµ±å®¹é‡</span><span class="result-value">${(lastInputs.Psys / 1000).toFixed(2)} kWp</span></div>
                    <div class="result-item"><span class="result-label">é›»ç¶²é›»å£“</span><span class="result-value">${lastInputs.Vgrid} V</span></div>
                    <div class="result-item"><span class="result-label">ç’°å¢ƒæº«åº¦ç¯„åœ</span><span class="result-value">${lastInputs.Tmin} Â°C ~ ${lastInputs.Tmax} Â°C</span></div>
                    <div class="result-item"><span class="result-label">æ¨¡çµ„åŠŸç‡</span><span class="result-value">${lastInputs.Pmod} W</span></div>
                    <div class="result-item"><span class="result-label">æ¨¡çµ„ Vmpp / Impp</span><span class="result-value">${lastInputs.Vmpp} V / ${lastInputs.Impp} A</span></div>
                    <div class="result-item"><span class="result-label">æ¨¡çµ„ Voc / Isc</span><span class="result-value">${lastInputs.Voc} V / ${lastInputs.Isc} A</span></div>
                    <div class="result-item"><span class="result-label">æº«åº¦ä¿‚æ•¸ Î±Voc / Î±Isc</span><span class="result-value">${(lastInputs.alphaVoc * 100).toFixed(2)}% / ${(lastInputs.alphaIsc * 100).toFixed(2)}%</span></div>
                    <div class="result-item"><span class="result-label">é€†è®Šå™¨ MPPT ç¯„åœ</span><span class="result-value">${lastInputs.VinvMpptMin} V ~ ${lastInputs.VinvMpptMax} V</span></div>
                    <div class="result-item"><span class="result-label">é€†è®Šå™¨æœ€å¤§è¼¸å…¥é›»æµ</span><span class="result-value">${lastInputs.IinvMax} A</span></div>
                    <div class="result-item"><span class="result-label">é€†è®Šå™¨é¡å®šåŠŸç‡ / é›»æµ</span><span class="result-value">${(lastInputs.PinvRated / 1000).toFixed(2)} kW / ${lastInputs.IinvRated} A</span></div>
                    <div class="result-item"><span class="result-label">DC / AC ç·šé•·</span><span class="result-value">${lastInputs.Ldc} m / ${lastInputs.Lac} m</span></div>
                    <div class="result-item"><span class="result-label">ç·šæå‘¨åœæº«åº¦</span><span class="result-value">${lastInputs.Twire} Â°C</span></div>
                </div>
            `;

            const arrayHTML = document.getElementById('arrayResults').innerHTML;
            const inverterHTML = document.getElementById('inverterResults').innerHTML;
            const cableHTML = document.getElementById('cableResults').innerHTML;
            const protectionHTML = document.getElementById('protectionResults').innerHTML;

            const printWindow = window.open('', '', 'width=900,height=1200');
            printWindow.document.write(`
                <html>
                <head>
                    <title>å¤ªé™½å…‰é›»ç³»çµ±è¦åŠƒå ±è¡¨</title>
                    <style>
                        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; padding: 20px; color: #222; }
                        h1 { color: #4c51bf; margin-bottom: 5px; }
                        h2 { color: #4c51bf; margin-top: 30px; margin-bottom: 10px; }
                        .meta { color: #555; margin-bottom: 20px; }
                        .result-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
                        .result-card h3 { margin: 0 0 10px; color: #4c51bf; }
                        .result-item { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f1f1; padding: 6px 0; font-size: 14px; }
                        .result-item:last-child { border-bottom: none; }
                        .result-label { font-weight: 600; }
                        .result-value { font-weight: 600; color: #111; }
                        .success { background: #e6ffed; border-left: 4px solid #16a34a; padding: 10px; margin: 8px 0; color: #166534; }
                        .warning { background: #fff4e5; border-left: 4px solid #f59e0b; padding: 10px; margin: 8px 0; color: #92400e; }
                        .formula { background: #fef9c3; border-left: 4px solid #f59e0b; padding: 10px; margin: 8px 0; font-family: 'Courier New', monospace; font-size: 13px; }
                        @media print { .result-card { page-break-inside: avoid; } }
                    </style>
                </head>
                <body>
                    <h1>å¤ªé™½å…‰é›»ç³»çµ±è¦åŠƒå ±è¡¨</h1>
                    <div class="meta">ç”Ÿæˆæ™‚é–“ï¼š${formattedDate}</div>
                    ${summaryHTML}
                    <h2>ğŸ“Š å¤ªé™½èƒ½æ¿é™£åˆ—è¦åŠƒ</h2>
                    <div class="result-card">${arrayHTML}</div>
                    <h2>âš¡ é€†è®Šå™¨è¦åŠƒ</h2>
                    <div class="result-card">${inverterHTML}</div>
                    <h2>ğŸ”Œ ç·šå¾‘è¦åŠƒ</h2>
                    <div class="result-card">${cableHTML}</div>
                    <h2>ğŸ›¡ï¸ ä¿è­·å…ƒä»¶è¦åŠƒ</h2>
                    <div class="result-card">${protectionHTML}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 300);
        }

        // ========== å°ˆæ¡ˆç®¡ç†åŠŸèƒ½ ==========

        // é¡¯ç¤ºå°ˆæ¡ˆåˆ—è¡¨
        async function showProjectList() {
            const modal = document.getElementById('projectModal');
            const content = document.getElementById('projectListContent');
            modal.classList.add('show');
            
            content.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            try {
                const projects = await supabase.getProjects();
                
                if (!projects || projects.length === 0) {
                    content.innerHTML = '<div class="empty-state">ğŸ“­ å°šç„¡å°ˆæ¡ˆï¼Œè«‹å…ˆå‰µå»ºä¸€å€‹å°ˆæ¡ˆ</div>';
                    return;
                }
                
                let html = '<ul class="project-list">';
                projects.forEach(project => {
                    const createdDate = new Date(project.created_at).toLocaleString('zh-TW');
                    const updatedDate = new Date(project.updated_at).toLocaleString('zh-TW');
                    html += `
                        <li class="project-item">
                            <div class="project-info">
                                <div class="project-name">${escapeHtml(project.name || 'æœªå‘½åå°ˆæ¡ˆ')}</div>
                                <div class="project-meta">
                                    å‰µå»ºæ™‚é–“: ${createdDate} | æ›´æ–°æ™‚é–“: ${updatedDate}
                                    ${project.description ? '<br>æè¿°: ' + escapeHtml(project.description) : ''}
                                </div>
                            </div>
                            <div class="project-item-actions">
                                <button class="btn btn-small btn-info btn-icon" onclick="loadProjectById(${project.id})">è¼‰å…¥</button>
                                <button class="btn btn-small btn-danger btn-icon" onclick="deleteProjectById(${project.id}, '${escapeHtml(project.name || 'æœªå‘½åå°ˆæ¡ˆ')}')">åˆªé™¤</button>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<div class="error">è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨å¤±æ•—: ${error.message}</div>`;
                console.error('Error loading projects:', error);
            }
        }

        // é—œé–‰å°ˆæ¡ˆåˆ—è¡¨æ¨¡æ…‹æ¡†
        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('show');
        }

        // é¡¯ç¤ºä¿å­˜å°ˆæ¡ˆæ¨¡æ…‹æ¡†
        function saveProject() {
            if (!lastInputs || !lastResults) {
                alert('è«‹å…ˆå®Œæˆè¨ˆç®—ï¼Œå†ä¿å­˜å°ˆæ¡ˆã€‚');
                return;
            }
            
            const modal = document.getElementById('saveModal');
            const nameInput = document.getElementById('projectName');
            const descInput = document.getElementById('projectDescription');
            
            // å¦‚æœæœ‰ç•¶å‰å°ˆæ¡ˆï¼Œé å¡«åç¨±
            if (currentProjectId) {
                // å¯ä»¥å¾è³‡æ–™åº«è¼‰å…¥ç•¶å‰å°ˆæ¡ˆåç¨±
            }
            
            nameInput.value = '';
            descInput.value = '';
            modal.classList.add('show');
        }

        // ç¢ºèªä¿å­˜å°ˆæ¡ˆ
        async function confirmSaveProject() {
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            
            if (!name) {
                alert('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±');
                return;
            }
            
            if (!lastInputs || !lastResults) {
                alert('æ²’æœ‰å¯ä¿å­˜çš„è³‡æ–™');
                return;
            }
            
            const projectData = {
                name: name,
                description: description || null,
                inputs: lastInputs,
                results: lastResults,
                updated_at: new Date().toISOString()
            };
            
            try {
                let result;
                if (currentProjectId) {
                    // æ›´æ–°ç¾æœ‰å°ˆæ¡ˆ
                    result = await supabase.updateProject(currentProjectId, projectData);
                    alert('å°ˆæ¡ˆå·²æ›´æ–°ï¼');
                } else {
                    // å‰µå»ºæ–°å°ˆæ¡ˆ
                    projectData.created_at = new Date().toISOString();
                    result = await supabase.createProject(projectData);
                    if (result && result.length > 0) {
                        currentProjectId = result[0].id;
                    }
                    alert('å°ˆæ¡ˆå·²ä¿å­˜ï¼');
                }
                closeSaveModal();
            } catch (error) {
                alert('ä¿å­˜å°ˆæ¡ˆå¤±æ•—: ' + error.message);
                console.error('Error saving project:', error);
            }
        }

        // é—œé–‰ä¿å­˜æ¨¡æ…‹æ¡†
        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('show');
        }

        // é¡¯ç¤ºè¼‰å…¥å°ˆæ¡ˆæ¨¡æ…‹æ¡†
        async function loadProject() {
            const modal = document.getElementById('loadModal');
            const content = document.getElementById('loadProjectListContent');
            modal.classList.add('show');
            
            content.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            try {
                const projects = await supabase.getProjects();
                
                if (!projects || projects.length === 0) {
                    content.innerHTML = '<div class="empty-state">ğŸ“­ å°šç„¡å°ˆæ¡ˆå¯è¼‰å…¥</div>';
                    return;
                }
                
                let html = '<ul class="project-list">';
                projects.forEach(project => {
                    const createdDate = new Date(project.created_at).toLocaleString('zh-TW');
                    html += `
                        <li class="project-item">
                            <div class="project-info">
                                <div class="project-name">${escapeHtml(project.name || 'æœªå‘½åå°ˆæ¡ˆ')}</div>
                                <div class="project-meta">å‰µå»ºæ™‚é–“: ${createdDate}</div>
                            </div>
                            <div class="project-item-actions">
                                <button class="btn btn-small btn-info btn-icon" onclick="loadProjectById(${project.id})">è¼‰å…¥</button>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<div class="error">è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨å¤±æ•—: ${error.message}</div>`;
                console.error('Error loading projects:', error);
            }
        }

        // æ ¹æ“š ID è¼‰å…¥å°ˆæ¡ˆ
        async function loadProjectById(projectId) {
            try {
                const projects = await supabase.getProject(projectId);
                
                if (!projects || projects.length === 0) {
                    alert('å°ˆæ¡ˆä¸å­˜åœ¨');
                    return;
                }
                
                const project = projects[0];
                
                if (!project.inputs || !project.results) {
                    alert('å°ˆæ¡ˆè³‡æ–™ä¸å®Œæ•´');
                    return;
                }
                
                // è¼‰å…¥è¼¸å…¥åƒæ•¸
                const inputs = project.inputs;
                document.getElementById('Psys').value = inputs.Psys / 1000;
                document.getElementById('Vgrid').value = inputs.Vgrid;
                document.getElementById('Tmin').value = inputs.Tmin;
                document.getElementById('Tmax').value = inputs.Tmax;
                document.getElementById('Pmod').value = inputs.Pmod;
                document.getElementById('Vmpp').value = inputs.Vmpp;
                document.getElementById('Impp').value = inputs.Impp;
                document.getElementById('Voc').value = inputs.Voc;
                document.getElementById('Isc').value = inputs.Isc;
                document.getElementById('alphaVoc').value = inputs.alphaVoc * 100;
                document.getElementById('alphaIsc').value = inputs.alphaIsc * 100;
                document.getElementById('VinvMax').value = inputs.VinvMax;
                document.getElementById('VinvMpptMin').value = inputs.VinvMpptMin;
                document.getElementById('VinvMpptMax').value = inputs.VinvMpptMax;
                document.getElementById('IinvMax').value = inputs.IinvMax;
                document.getElementById('PinvRated').value = inputs.PinvRated / 1000;
                document.getElementById('IinvRated').value = inputs.IinvRated;
                document.getElementById('Ldc').value = inputs.Ldc;
                document.getElementById('Lac').value = inputs.Lac;
                document.getElementById('Twire').value = inputs.Twire;
                document.getElementById('rho').value = inputs.rho;
                
                // æ¢å¾©é¸ä¸­çš„è¨­å‚™ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                if (inputs.solarPanelId) {
                    document.getElementById('solarPanelSelect').value = inputs.solarPanelId;
                } else {
                    document.getElementById('solarPanelSelect').value = '';
                }
                
                if (inputs.inverterId) {
                    document.getElementById('inverterSelect').value = inputs.inverterId;
                } else {
                    document.getElementById('inverterSelect').value = '';
                }
                
                // ä¿å­˜ç•¶å‰ç‹€æ…‹
                lastInputs = inputs;
                lastResults = project.results;
                currentProjectId = projectId;
                
                // é¡¯ç¤ºçµæœ
                displayResults(project.results);
                
                // é—œé–‰æ¨¡æ…‹æ¡†
                closeLoadModal();
                closeProjectModal();
                
                alert('å°ˆæ¡ˆå·²è¼‰å…¥ï¼');
                
                // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨
                document.querySelector('.content').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                alert('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—: ' + error.message);
                console.error('Error loading project:', error);
            }
        }

        // é—œé–‰è¼‰å…¥æ¨¡æ…‹æ¡†
        function closeLoadModal() {
            document.getElementById('loadModal').classList.remove('show');
        }

        // åˆªé™¤å°ˆæ¡ˆ
        async function deleteProjectById(projectId, projectName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å°ˆæ¡ˆã€Œ${projectName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }
            
            try {
                await supabase.deleteProject(projectId);
                
                if (currentProjectId === projectId) {
                    currentProjectId = null;
                }
                
                alert('å°ˆæ¡ˆå·²åˆªé™¤ï¼');
                
                // é‡æ–°è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨
                showProjectList();
            } catch (error) {
                alert('åˆªé™¤å°ˆæ¡ˆå¤±æ•—: ' + error.message);
                console.error('Error deleting project:', error);
            }
        }

        // æ–°å»ºå°ˆæ¡ˆ
        function newProject() {
            if (confirm('ç¢ºå®šè¦å‰µå»ºæ–°å°ˆæ¡ˆå—ï¼Ÿç•¶å‰æœªä¿å­˜çš„è³‡æ–™å°‡ä¸Ÿå¤±ã€‚')) {
                // é‡ç½®è¡¨å–®
                document.getElementById('calculationForm').reset();
                
                // é‡ç½®ç‹€æ…‹
                lastInputs = null;
                lastResults = null;
                currentProjectId = null;
                
                // éš±è—çµæœ
                document.getElementById('results').classList.remove('show');
                
                // æ»¾å‹•åˆ°é ‚éƒ¨
                document.querySelector('.content').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // HTML è½‰ç¾©å‡½æ•¸
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const projectModal = document.getElementById('projectModal');
            const saveModal = document.getElementById('saveModal');
            const loadModal = document.getElementById('loadModal');
            
            if (event.target === projectModal) {
                closeProjectModal();
            }
            if (event.target === saveModal) {
                closeSaveModal();
            }
            if (event.target === loadModal) {
                closeLoadModal();
            }
        }

        // ========== è¨­å‚™è³‡æ–™è¼‰å…¥åŠŸèƒ½ ==========

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–è¨­å‚™è³‡æ–™
        async function initializeEquipmentData() {
            console.log('åˆå§‹åŒ–è¨­å‚™è³‡æ–™...');
            
            // æª¢æŸ¥ supabase æ˜¯å¦å·²è¼‰å…¥
            if (typeof supabase === 'undefined') {
                console.error('supabase æœªå®šç¾©ï¼Œè«‹ç¢ºèª supabase-config.js å·²æ­£ç¢ºè¼‰å…¥');
                setTimeout(initializeEquipmentData, 500); // 500ms å¾Œé‡è©¦
                return;
            }
            
            // æª¢æŸ¥å¿…è¦çš„ DOM å…ƒç´ æ˜¯å¦å­˜åœ¨
            const solarSelect = document.getElementById('solarPanelSelect');
            const inverterSelect = document.getElementById('inverterSelect');
            
            if (!solarSelect || !inverterSelect) {
                console.warn('DOM å…ƒç´ å°šæœªæº–å‚™å¥½ï¼Œç¨å¾Œé‡è©¦...');
                setTimeout(initializeEquipmentData, 500);
                return;
            }
            
            try {
                await loadSolarPanels();
                await loadInverters();
                // é è¼‰å…¥è¼‰æµé‡è¡¨ï¼ˆä½¿ç”¨é è¨­å€¼ï¼‰
                await loadAmpacityTable('metal', 60, '3');
                console.log('è¨­å‚™è³‡æ–™åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–è¨­å‚™è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // ç¢ºä¿åœ¨ DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        function startInitialization() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(initializeEquipmentData, 100); // çµ¦ä¸€é»æ™‚é–“è®“å…¶ä»–è…³æœ¬è¼‰å…¥
                });
            } else {
                // DOM å·²ç¶“è¼‰å…¥å®Œæˆï¼Œç¨ç­‰ä¸€ä¸‹ç¢ºä¿æ‰€æœ‰è…³æœ¬éƒ½è¼‰å…¥
                setTimeout(initializeEquipmentData, 100);
            }
        }
        
        // é–‹å§‹åˆå§‹åŒ–
        startInitialization();

        // è¼‰å…¥å¤ªé™½èƒ½æ¿è³‡æ–™
        async function loadSolarPanels() {
            try {
                console.log('é–‹å§‹è¼‰å…¥å¤ªé™½èƒ½æ¿è³‡æ–™...');
                const panels = await supabase.getSolarPanels();
                console.log('å¤ªé™½èƒ½æ¿è³‡æ–™:', panels);
                
                solarPanelsData = panels || [];
                
                const select = document.getElementById('solarPanelSelect');
                if (!select) {
                    console.error('æ‰¾ä¸åˆ° solarPanelSelect å…ƒç´ ');
                    return;
                }
                
                select.innerHTML = '<option value="">-- è«‹é¸æ“‡å¤ªé™½èƒ½æ¿ --</option>';
                
                if (!panels || panels.length === 0) {
                    console.warn('è³‡æ–™åº«ä¸­æ²’æœ‰å¤ªé™½èƒ½æ¿è³‡æ–™');
                    select.innerHTML += '<option value="" disabled>âš ï¸ è³‡æ–™åº«ä¸­å°šç„¡å¤ªé™½èƒ½æ¿è³‡æ–™ï¼ˆè«‹åŸ·è¡Œ supabase-equipment-schema.sqlï¼‰</option>';
                    return;
                }
                
                solarPanelsData.forEach(panel => {
                    const option = document.createElement('option');
                    option.value = panel.id;
                    // æ ¹æ“šå¯¦éš›æ¬„ä½åç¨±ï¼šmanufacturer, series, model_number
                    const manufacturer = panel.manufacturer || '';
                    const series = panel.series || '';
                    const modelNumber = panel.model_number || '';
                    // çµ„åˆé¡¯ç¤ºåç¨±ï¼šè£½é€ å•† + ç³»åˆ— + å‹è™Ÿ
                    let displayName = '';
                    if (manufacturer) displayName += manufacturer;
                    if (series) displayName += (displayName ? ' ' : '') + series;
                    if (modelNumber) displayName += (displayName ? ' ' : '') + modelNumber;
                    if (!displayName) displayName = `ID: ${panel.id}`;
                    option.textContent = displayName;
                    option.setAttribute('data-panel', JSON.stringify(panel));
                    select.appendChild(option);
                });
                
                console.log(`æˆåŠŸè¼‰å…¥ ${solarPanelsData.length} ç­†å¤ªé™½èƒ½æ¿è³‡æ–™`);
            } catch (error) {
                console.error('è¼‰å…¥å¤ªé™½èƒ½æ¿è³‡æ–™å¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    stack: error.stack
                });
                const select = document.getElementById('solarPanelSelect');
                if (select) {
                    select.innerHTML = '<option value="">âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«é€£ç·šæˆ–æ‰‹å‹•è¼¸å…¥è¦æ ¼</option>';
                }
                showNotification('è¼‰å…¥å¤ªé™½èƒ½æ¿è³‡æ–™å¤±æ•—: ' + error.message, 'error');
            }
        }

        // è¼‰å…¥é€†è®Šå™¨è³‡æ–™
        async function loadInverters() {
            try {
                console.log('é–‹å§‹è¼‰å…¥é€†è®Šå™¨è³‡æ–™...');
                const inverters = await supabase.getInverters();
                console.log('é€†è®Šå™¨è³‡æ–™:', inverters);
                
                invertersData = inverters || [];
                
                const select = document.getElementById('inverterSelect');
                if (!select) {
                    console.error('æ‰¾ä¸åˆ° inverterSelect å…ƒç´ ');
                    return;
                }
                
                select.innerHTML = '<option value="">-- è«‹é¸æ“‡é€†è®Šå™¨ --</option>';
                
                if (!inverters || inverters.length === 0) {
                    console.warn('è³‡æ–™åº«ä¸­æ²’æœ‰é€†è®Šå™¨è³‡æ–™');
                    select.innerHTML += '<option value="" disabled>âš ï¸ è³‡æ–™åº«ä¸­å°šç„¡é€†è®Šå™¨è³‡æ–™ï¼ˆè«‹åŸ·è¡Œ supabase-equipment-schema.sqlï¼‰</option>';
                    return;
                }
                
                invertersData.forEach(inverter => {
                    const option = document.createElement('option');
                    option.value = inverter.id;
                    // æ ¹æ“šå¯¦éš›æ¬„ä½åç¨±ï¼šmodel_name
                    const modelName = inverter.model_name || `ID: ${inverter.id}`;
                    option.textContent = modelName;
                    option.setAttribute('data-inverter', JSON.stringify(inverter));
                    select.appendChild(option);
                });
                
                console.log(`æˆåŠŸè¼‰å…¥ ${invertersData.length} ç­†é€†è®Šå™¨è³‡æ–™`);
            } catch (error) {
                console.error('è¼‰å…¥é€†è®Šå™¨è³‡æ–™å¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    stack: error.stack
                });
                const select = document.getElementById('inverterSelect');
                if (select) {
                    select.innerHTML = '<option value="">âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«é€£ç·šæˆ–æ‰‹å‹•è¼¸å…¥è¦æ ¼</option>';
                }
                showNotification('è¼‰å…¥é€†è®Šå™¨è³‡æ–™å¤±æ•—: ' + error.message, 'error');
            }
        }

        // è¼‰å…¥é¸ä¸­çš„å¤ªé™½èƒ½æ¿è¦æ ¼
        function loadSolarPanelSpecs() {
            const select = document.getElementById('solarPanelSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                return;
            }
            
            try {
                const panel = JSON.parse(selectedOption.getAttribute('data-panel'));
                
                // æ ¹æ“šå¯¦éš›æ¬„ä½åç¨±è‡ªå‹•å¡«å…¥è¦æ ¼
                // solar_modules è¡¨æ¬„ä½ï¼šp_max, v_oc, i_sc, v_mp, i_mp, temp_coef_voc, temp_coef_isc
                document.getElementById('Pmod').value = panel.p_max || panel.pmod || panel.power || '';
                document.getElementById('Vmpp').value = panel.v_mp || panel.vmpp || panel.v_mpp || '';
                document.getElementById('Impp').value = panel.i_mp || panel.impp || panel.i_mpp || '';
                document.getElementById('Voc').value = panel.v_oc || panel.voc || panel.v_oc || '';
                document.getElementById('Isc').value = panel.i_sc || panel.isc || panel.i_sc || '';
                // æº«åº¦ä¿‚æ•¸ï¼šæ³¨æ„è³‡æ–™åº«ä¸­æ˜¯æ•¸å€¼ï¼ˆå¦‚ -0.27ï¼‰ï¼Œéœ€è¦è½‰æ›ç‚ºç™¾åˆ†æ¯”ï¼ˆ-0.27%ï¼‰
                const tempCoefVoc = panel.temp_coef_voc !== null && panel.temp_coef_voc !== undefined ? panel.temp_coef_voc : (panel.alpha_voc || '');
                const tempCoefIsc = panel.temp_coef_isc !== null && panel.temp_coef_isc !== undefined ? panel.temp_coef_isc : (panel.alpha_isc || '');
                document.getElementById('alphaVoc').value = tempCoefVoc;
                document.getElementById('alphaIsc').value = tempCoefIsc;
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showNotification('å¤ªé™½èƒ½æ¿è¦æ ¼å·²è‡ªå‹•å¡«å…¥', 'success');
            } catch (error) {
                console.error('è¼‰å…¥å¤ªé™½èƒ½æ¿è¦æ ¼å¤±æ•—:', error);
                showNotification('è¼‰å…¥è¦æ ¼å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥', 'error');
            }
        }

        // è¼‰å…¥é¸ä¸­çš„é€†è®Šå™¨è¦æ ¼
        function loadInverterSpecs() {
            const select = document.getElementById('inverterSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                return;
            }
            
            try {
                const inverter = JSON.parse(selectedOption.getAttribute('data-inverter'));
                
                // æ ¹æ“šå¯¦éš›æ¬„ä½åç¨±è‡ªå‹•å¡«å…¥è¦æ ¼
                // delta_inverters è¡¨æ¬„ä½ï¼šmax_input_voltage_v, mppt_voltage_range_v, max_input_current_total_a, rated_output_power_kw, max_output_current_a
                document.getElementById('VinvMax').value = inverter.max_input_voltage_v || inverter.vinv_max || '';
                
                // MPPT é›»å£“ç¯„åœå¯èƒ½æ˜¯æ–‡å­—æ ¼å¼ï¼ˆå¦‚ "200-800"ï¼‰ï¼Œéœ€è¦è§£æ
                let mpptMin = '';
                let mpptMax = '';
                if (inverter.mppt_voltage_range_v) {
                    // å˜—è©¦è§£æç¯„åœæ ¼å¼ï¼ˆå¦‚ "200-800" æˆ– "200V~800V"ï¼‰
                    const rangeMatch = inverter.mppt_voltage_range_v.toString().match(/(\d+(?:\.\d+)?)[\s\-~è‡³åˆ°]+(\d+(?:\.\d+)?)/);
                    if (rangeMatch) {
                        mpptMin = rangeMatch[1];
                        mpptMax = rangeMatch[2];
                    } else {
                        // å¦‚æœç„¡æ³•è§£æï¼Œå˜—è©¦å…¶ä»–æ¬„ä½
                        mpptMin = inverter.vinv_mppt_min || '';
                        mpptMax = inverter.vinv_mppt_max || '';
                    }
                } else {
                    mpptMin = inverter.vinv_mppt_min || '';
                    mpptMax = inverter.vinv_mppt_max || '';
                }
                document.getElementById('VinvMpptMin').value = mpptMin;
                document.getElementById('VinvMpptMax').value = mpptMax;
                
                // æœ€å¤§è¼¸å…¥é›»æµï¼ˆå¯èƒ½æ˜¯æ–‡å­—æ ¼å¼ï¼‰
                const maxInputCurrent = inverter.max_input_current_total_a || inverter.iinv_max || '';
                document.getElementById('IinvMax').value = typeof maxInputCurrent === 'string' ? maxInputCurrent.replace(/[^\d.]/g, '') : maxInputCurrent;
                
                // é¡å®šè¼¸å‡ºåŠŸç‡ï¼ˆkWï¼Œéœ€è¦ä¿æŒç‚º kWï¼‰
                document.getElementById('PinvRated').value = inverter.rated_output_power_kw || inverter.pinv_rated || '';
                
                // æœ€å¤§è¼¸å‡ºé›»æµï¼ˆå¯èƒ½æ˜¯æ–‡å­—æ ¼å¼ï¼‰
                const maxOutputCurrent = inverter.max_output_current_a || inverter.iinv_rated || '';
                document.getElementById('IinvRated').value = typeof maxOutputCurrent === 'string' ? maxOutputCurrent.replace(/[^\d.]/g, '') : maxOutputCurrent;
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showNotification('é€†è®Šå™¨è¦æ ¼å·²è‡ªå‹•å¡«å…¥', 'success');
            } catch (error) {
                console.error('è¼‰å…¥é€†è®Šå™¨è¦æ ¼å¤±æ•—:', error);
                showNotification('è¼‰å…¥è¦æ ¼å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥', 'error');
            }
        }

        // é¡¯ç¤ºé€šçŸ¥è¨Šæ¯
        function showNotification(message, type = 'info') {
            // å‰µå»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease-out;
            `;
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            } else {
                notification.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // æ·»åŠ å‹•ç•«æ¨£å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
